"use strict";(self.webpackChunkdocs_1=self.webpackChunkdocs_1||[]).push([[3752],{3905:function(e,t,n){n.d(t,{Zo:function(){return p},kt:function(){return h}});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),u=c(n),h=r,m=u["".concat(l,".").concat(h)]||u[h]||d[h]||o;return n?a.createElement(m,i(i({ref:t},p),{},{components:n})):a.createElement(m,i({ref:t},p))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=u;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,i[1]=s;for(var c=2;c<o;c++)i[c]=n[c];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},2948:function(e,t,n){n.r(t),n.d(t,{assets:function(){return p},contentTitle:function(){return l},default:function(){return h},frontMatter:function(){return s},metadata:function(){return c},toc:function(){return d}});var a=n(7462),r=n(3366),o=(n(7294),n(3905)),i=["components"],s={sidebar_position:1},l="Subsquid",c={unversionedId:"integrations/indexers/subsquid",id:"integrations/indexers/subsquid",title:"Subsquid",description:"[Subsquid]//subsquid.io/",source:"@site/docs/integrations/indexers/subsquid.md",sourceDirName:"integrations/indexers",slug:"/integrations/indexers/subsquid",permalink:"/docs/integrations/indexers/subsquid",editUrl:"https://github.com/AstarNetwork/astar-docs/tree/main/docs/integrations/indexers/subsquid.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1},sidebar:"tutorialSidebar",previous:{title:"Blast",permalink:"/docs/integrations/node-providers/blast"},next:{title:"SubQuery",permalink:"/docs/integrations/indexers/subquery"}},p={},d=[{value:"What is Subsquid?",id:"what-is-subsquid",level:2},{value:"Getting Started",id:"getting-started",level:2},{value:"Define Entity Schema",id:"define-entity-schema",level:2},{value:"ABI Definition and Wrapper",id:"abi-definition-and-wrapper",level:2},{value:"Define and Bind Event Handler(s)",id:"define-and-bind-event-handlers",level:2},{value:"Managing the EVM contract",id:"managing-the-evm-contract",level:3},{value:"Configure Processor and Attach Handler",id:"configure-processor-and-attach-handler",level:3},{value:"Launch and Set Up the Database",id:"launch-and-set-up-the-database",level:2},{value:"Launch the Project",id:"launch-the-project",level:2},{value:"Publish the Project",id:"publish-the-project",level:2},{value:"Example Project Repository",id:"example-project-repository",level:2},{value:"What&#39;s next",id:"whats-next",level:2}],u={toc:d};function h(e){var t=e.components,s=(0,r.Z)(e,i);return(0,o.kt)("wrapper",(0,a.Z)({},u,s,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"subsquid"},"Subsquid"),(0,o.kt)("h2",{id:"what-is-subsquid"},"What is Subsquid?"),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://subsquid.io/"},"Subsquid")," is a query node framework for Substrate-based blockchains. In very simple terms, Subsquid can be thought of as an ETL (Extract, Transform, and Load) tool, with a GraphQL server included. It enables comprehensive filtering, pagination, and even full-text search capabilities."),(0,o.kt)("p",null,"Subsquid has native and full support for both the Ethereum Virtual Machine and Substrate data. This allows developers to extract on-chain data from any of the Astar networks and process EVM logs as well as Substrate entities (events, extrinsics and storage items) in one single project and serve the resulting data with one single GraphQL endpoint. With Subsquid, filtering by EVM topic, contract address, and block range are all possible."),(0,o.kt)("p",null,'This guide will explain how to create a Subsquid project (also known as a "',(0,o.kt)("em",{parentName:"p"},"Squid"),"\") that indexes ERC-721 token transfers on the Astar network. As such, you'll be looking at the ",(0,o.kt)("inlineCode",{parentName:"p"},"Transfer")," EVM event topics. This guide can be adapted for Shiden network and other type of tokens as well."),(0,o.kt)("p",null,"Prerequisites\nFor a Squid project to be able to run, you need to have the following installed:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://nodejs.org/en/download/"},"Node.js"),": version 16 or later"),(0,o.kt)("li",{parentName:"ul"},"Docker")),(0,o.kt)("h2",{id:"getting-started"},"Getting Started"),(0,o.kt)("p",null,"You can create a project by using the template repository made available by Subsquid. To get started, you can take the following steps:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Vist the ",(0,o.kt)("a",{parentName:"li",href:"https://github.com/subsquid/squid-evm-template"},(0,o.kt)("inlineCode",{parentName:"a"},"squid-evm-template")," repository on GitHub")),(0,o.kt)("li",{parentName:"ol"},"Click the ",(0,o.kt)("strong",{parentName:"li"},"Use this template")," button"),(0,o.kt)("li",{parentName:"ol"},"Select the account and repository name for your project"),(0,o.kt)("li",{parentName:"ol"},"Clone the created repository (be careful of changing ",(0,o.kt)("inlineCode",{parentName:"li"},"account")," with your own GitHub account):")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"git clone git@github.com:<account>/squid-evm-template.git\n")),(0,o.kt)("ol",{start:5},(0,o.kt)("li",{parentName:"ol"},"Then you can install the dependencies from within the project directory:")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"cd squid-evm-template && npm i\n")),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"1",src:n(6797).Z,width:"944",height:"720"})),(0,o.kt)("p",null,"The next sections will take the template and customize it, one aspect at a time, to obtain the right data and process it. To view the complete project, you can check out the ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/subsquid/squid-astar-example"},(0,o.kt)("inlineCode",{parentName:"a"},"squid-astar-example")," repository on GitHub"),"."),(0,o.kt)("h2",{id:"define-entity-schema"},"Define Entity Schema"),(0,o.kt)("p",null,"The EVM template already contains a schema that defines the exact entities we need for the purpose of this guide. For this reason, changes are necessary, but it's still useful to explain what is going on."),(0,o.kt)("p",null,"To index ERC-721 token transfers, we will need to track:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Token transfers"),(0,o.kt)("li",{parentName:"ul"},"Ownership of tokens"),(0,o.kt)("li",{parentName:"ul"},"Contracts and their minted tokens")),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"schema.graphql")," file defines them like this:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-graphql"},'type Token @entity {\n  id: ID!\n  owner: Owner\n  uri: String\n  transfers: [Transfer!]! @derivedFrom(field: "token")\n  contract: Contract\n}\n\ntype Owner @entity {\n  id: ID!\n  ownedTokens: [Token!]! @derivedFrom(field: "owner")\n  balance: BigInt\n}\n\ntype Contract @entity {\n  id: ID!\n  name: String\n  symbol: String\n  totalSupply: BigInt\n  mintedTokens: [Token!]! @derivedFrom(field: "contract")\n}\n\ntype Transfer @entity {\n  id: ID!\n  token: Token!\n  from: Owner\n  to: Owner\n  timestamp: BigInt!\n  block: Int!\n  transactionHash: String!\n}\n')),(0,o.kt)("p",null,"It's worth noting a couple of things in this ",(0,o.kt)("a",{parentName:"p",href:"https://docs.subsquid.io/reference/openreader-schema"},"schema definition"),":"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"@entity")," - signals that this type will be translated into an ORM model that is going to be persisted in the database"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"@derivedFrom")," - signals the field will not be persisted on the database, it will rather be derived"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"type references")," (i.e. ",(0,o.kt)("inlineCode",{parentName:"li"},"from: Owner"),") - establishes a relation between two entities")),(0,o.kt)("p",null,"The template already has automatically generated TypeScript classes for this schema definition. They can be found under ",(0,o.kt)("inlineCode",{parentName:"p"},"src/model/generated"),".\nWhenever changes are made to the schema, new TypeScript entity classes have to be generated, and to do that you'll have to run the ",(0,o.kt)("inlineCode",{parentName:"p"},"codegen")," tool:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"npx sqd codegen\n")),(0,o.kt)("h2",{id:"abi-definition-and-wrapper"},"ABI Definition and Wrapper"),(0,o.kt)("p",null,"Subsquid offers support for automatically building TypeScript type-safe interfaces for Substrate data sources (events, extrinsics, storage items). Changes are automatically detected in the runtime."),(0,o.kt)("p",null,"This functionality has been extended to EVM indexing, with the release of an ",(0,o.kt)("inlineCode",{parentName:"p"},"evm-typegen")," tool to generate TypeScript interfaces and decoding functions for EVM logs."),(0,o.kt)("p",null,"Once again, the template repository already includes interfaces for ERC-721 contracts, which is the subject of this guide. But it is still important to explain what needs to be done, in case, for example, one wants to index a different type of contract."),(0,o.kt)("p",null,"First of all, it is necessary to obtain the definition of its Application Binary Interface (ABI). This can be obtained in the form of a JSON file, which will be imported into the project."),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"It is advisable to copy the JSON file in the ",(0,o.kt)("inlineCode",{parentName:"li"},"src/abis")," subfolder."),(0,o.kt)("li",{parentName:"ol"},"To automatically generate TypeScript interfaces from an ABI definition, and decode event data, simply run this command from the project's root folder")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"npx squid-evm-typegen --abi src/abi/ERC721.json --output src/abi/erc721.ts\n")),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"abi")," parameter points at the JSON file previously created, and the output parameter is the name of the file that will be generated by the command itself."),(0,o.kt)("p",null,"This command will automatically generate a TypeScript file named ",(0,o.kt)("inlineCode",{parentName:"p"},"erc721.ts"),", under the ",(0,o.kt)("inlineCode",{parentName:"p"},"src/abi")," subfolder, that defines data interfaces to represent output of the EVM events defined in the ABI, as well as a mapping of the functions necessary to decode these events (see the events dictionary in the aforementione file)."),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"NOTE: The ERC-721 ABI defines the signatures of all events in the contract. The ",(0,o.kt)("inlineCode",{parentName:"p"},"Transfer")," event has three arguments, named: ",(0,o.kt)("inlineCode",{parentName:"p"},"from"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"to"),", and ",(0,o.kt)("inlineCode",{parentName:"p"},"tokenId"),". Their types are, respectively, ",(0,o.kt)("inlineCode",{parentName:"p"},"address"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"address"),", and ",(0,o.kt)("inlineCode",{parentName:"p"},"uint256"),". As such, the actual definition of the ",(0,o.kt)("inlineCode",{parentName:"p"},"Transfer")," event looks like this: ",(0,o.kt)("inlineCode",{parentName:"p"},"Transfer(address, address, uint256)"),".")),(0,o.kt)("h2",{id:"define-and-bind-event-handlers"},"Define and Bind Event Handler(s)"),(0,o.kt)("p",null,"The Subsquid SDK provides users with a ",(0,o.kt)("a",{parentName:"p",href:"https://docs.subsquid.io/key-concepts/processor"},"processor")," class, named ",(0,o.kt)("inlineCode",{parentName:"p"},"SubstrateProcessor")," or, in this specific case ",(0,o.kt)("a",{parentName:"p",href:"https://docs.subsquid.io/reference/evm-processor"},(0,o.kt)("inlineCode",{parentName:"a"},"SubstrateEvmProcessor")),". The processor connects to the ",(0,o.kt)("a",{parentName:"p",href:"https://docs.subsquid.io/key-concepts/architecture#archive"},"Subsquid archive")," to get chain data. It will index from the configured starting block, until the configured end block, or until new data is added to the chain."),(0,o.kt)("p",null,'The processor exposes methods to "attach" functions that will "handle" specific data such as Substrate events, extrinsics, storage items, or EVM logs. These methods can be configured by specifying the event or extrinsic name, or the EVM log contract address, for example. As the processor loops over the data, when it encounters one of the configured event names, it will execute the logic in the "handler" function.'),(0,o.kt)("h3",{id:"managing-the-evm-contract"},"Managing the EVM contract"),(0,o.kt)("p",null,"It is worth pointing out, at this point, that some important auxiliary code like constants and helper functions to manage the EVM contract is defined in the ",(0,o.kt)("inlineCode",{parentName:"p"},"src/contracts.ts")," file. Here's a summary of what is in it:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Define the chain node endpoint (optional but useful)"),(0,o.kt)("li",{parentName:"ul"},"Create a contract interface to store information such as the address and ABI"),(0,o.kt)("li",{parentName:"ul"},"Define functions to fetch a contract entity from the database or create one"),(0,o.kt)("li",{parentName:"ul"},"Define the ",(0,o.kt)("inlineCode",{parentName:"li"},"processTransfer")," EVM log handler, implementing logic to track token transfers")),(0,o.kt)("p",null,"In order to adapt the template to the scope of this guide, we need to apply a couple of changes:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Edit the ",(0,o.kt)("inlineCode",{parentName:"li"},"CHAIN_NODE")," constant to the endpoint URL of Astar network (e.g. ",(0,o.kt)("inlineCode",{parentName:"li"},"wss://astar.api.onfinality.io/public-ws"),")"),(0,o.kt)("li",{parentName:"ol"},"Edit the hexadecimal address used to create the ",(0,o.kt)("inlineCode",{parentName:"li"},"contract")," constant (we are going to use ",(0,o.kt)("a",{parentName:"li",href:"https://blockscout.com/astar/token/0xd59fC6Bfd9732AB19b03664a45dC29B8421BDA9a/token-transfers"},"this token")," for the purpose of this guide)"),(0,o.kt)("li",{parentName:"ol"},"Change the ",(0,o.kt)("inlineCode",{parentName:"li"},"name"),", ",(0,o.kt)("inlineCode",{parentName:"li"},"symbol")," and ",(0,o.kt)("inlineCode",{parentName:"li"},"totalSupply")," values used in the ",(0,o.kt)("inlineCode",{parentName:"li"},"createContractEntity")," function to their correct values (see link in the previous point)")),(0,o.kt)("p",null,"In case someone wants to index an EVM event different from ",(0,o.kt)("inlineCode",{parentName:"p"},"Transfer"),", they would also have to implement a different handler function from ",(0,o.kt)("inlineCode",{parentName:"p"},"processTransfer"),', especially the line where the event "',(0,o.kt)("inlineCode",{parentName:"p"},"Transfer(address,address,uint256)"),'" is decoded.'),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},'// src/contract.ts\nimport { assertNotNull, EvmLogHandlerContext, Store } from "@subsquid/substrate-evm-processor";\nimport { ethers } from "ethers";\nimport { Contract, Owner, Token, Transfer } from "./model";\nimport { events, abi } from "./abi/erc721"\n\nexport const CHAIN_NODE = "wss://astar.api.onfinality.io/public-ws";\n\nexport const contract = new ethers.Contract(\n  "0xd59fC6Bfd9732AB19b03664a45dC29B8421BDA9a",\n  abi,\n  new ethers.providers.WebSocketProvider(CHAIN_NODE)\n);\n\nexport function createContractEntity(): Contract {\n  return new Contract({\n    id: contract.address,\n    name: "AstarDegens",\n    symbol: "DEGEN",\n    totalSupply: 10000n,\n  });\n}\n\nlet contractEntity: Contract | undefined;\n\nexport async function getContractEntity({\n  store,\n}: {\n  store: Store;\n}): Promise<Contract> {\n  if (contractEntity == null) {\n    contractEntity = await store.get(Contract, contract.address);\n  }\n  return assertNotNull(contractEntity);\n}\n\n\nexport async function processTransfer(ctx: EvmLogHandlerContext): Promise<void> {\n  const transfer =\n    events["Transfer(address,address,uint256)"].decode(ctx);\n\n  let from = await ctx.store.get(Owner, transfer.from);\n  if (from == null) {\n    from = new Owner({ id: transfer.from, balance: 0n });\n    await ctx.store.save(from);\n  }\n\n  let to = await ctx.store.get(Owner, transfer.to);\n  if (to == null) {\n    to = new Owner({ id: transfer.to, balance: 0n });\n    await ctx.store.save(to);\n  }\n\n  let token = await ctx.store.get(Token, transfer.tokenId.toString());\n  if (token == null) {\n    token = new Token({\n      id: transfer.tokenId.toString(),\n      uri: await contract.tokenURI(transfer.tokenId),\n      contract: await getContractEntity(ctx),\n      owner: to,\n    });\n    await ctx.store.save(token);\n  } else {\n    token.owner = to;\n    await ctx.store.save(token);\n  }\n\n  await ctx.store.save(\n    new Transfer({\n      id: ctx.txHash,\n      token,\n      from,\n      to,\n      timestamp: BigInt(ctx.substrate.block.timestamp),\n      block: ctx.substrate.block.height,\n      transactionHash: ctx.txHash,\n    })\n  );\n}\n')),(0,o.kt)("p",null,'The "handler" function takes in a ',(0,o.kt)("inlineCode",{parentName:"p"},"Context")," of the correct type (",(0,o.kt)("inlineCode",{parentName:"p"},"EvmLogHandlerContext"),", in this case). The context contains the triggering event and the interface to store data, and is used to extract and process data and save it to the database."),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"For the event handler, it is also possible to bind an arrow function to the processor.")),(0,o.kt)("h3",{id:"configure-processor-and-attach-handler"},"Configure Processor and Attach Handler"),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"src/processor.ts")," file is where the template project instantiates the ",(0,o.kt)("inlineCode",{parentName:"p"},"SubstrateEvmProcessor")," class, configures it for execution, and attaches the handler functions(s).\nLuckily for us, most of the job is already done. It is important to note that, since the template was built for the ",(0,o.kt)("inlineCode",{parentName:"p"},"moonriver")," network, there are a couple of things to change:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Change the name argument passed to ",(0,o.kt)("inlineCode",{parentName:"li"},"SubstrateEvmProcessor")," constructor (not necessary, but good practice)"),(0,o.kt)("li",{parentName:"ol"},"Change the archive parameter of the ",(0,o.kt)("inlineCode",{parentName:"li"},"setDataSource")," function to fetch the Archive URL for Astar."),(0,o.kt)("li",{parentName:"ol"},"Change the argument passed to the ",(0,o.kt)("inlineCode",{parentName:"li"},"setTypesBundle")," function to ",(0,o.kt)("inlineCode",{parentName:"li"},'"astar"'),".")),(0,o.kt)("p",null,"Look at this code snippet for the end result:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},'// src/processor.ts\nimport { SubstrateEvmProcessor } from "@subsquid/substrate-evm-processor";\nimport { lookupArchive } from "@subsquid/archive-registry";\nimport {\n  CHAIN_NODE,\n  contract,\n  createContractEntity,\n  processTransfer,\n} from "./contract";\nimport { events } from "./abi/erc721";\n\nconst processor = new SubstrateEvmProcessor("astar-substrate");\n\nprocessor.setBatchSize(500);\n\nprocessor.setDataSource({\n  chain: CHAIN_NODE,\n  archive: lookupArchive("astar")[0].url,\n});\n\nprocessor.setTypesBundle("astar");\n\nprocessor.addPreHook({ range: { from: 0, to: 0 } }, async (ctx) => {\n  await ctx.store.save(createContractEntity());\n});\n\nprocessor.addEvmLogHandler(\n  contract.address,\n  {\n    filter: [events["Transfer(address,address,uint256)"].topic],\n  },\n  processTransfer\n);\n\nprocessor.run();\n')),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"The ",(0,o.kt)("inlineCode",{parentName:"p"},"lookupArchive")," function is used to consult the ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/subsquid/archive-registry"},"archive registry")," and yield the archive address, given a network name. Network names should be in lowercase.")),(0,o.kt)("h2",{id:"launch-and-set-up-the-database"},"Launch and Set Up the Database"),(0,o.kt)("p",null,"When running the project locally, as it is the case for this guide, it is possible to use the ",(0,o.kt)("inlineCode",{parentName:"p"},"docker-compose.yml")," file that comes with the template to launch a PostgreSQL container. To do so, run the following command in your terminal:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"docker-compose up -d\n")),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"2",src:n(3094).Z,width:"944",height:"720"})),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"The ",(0,o.kt)("inlineCode",{parentName:"p"},"-d")," parameter is optional, it launches the container in ",(0,o.kt)("inlineCode",{parentName:"p"},"daemon")," mode so the terminal will not be blocked and no further output will be visible.")),(0,o.kt)("p",null,"Squid projects automatically manage the database connection and schema, via an ",(0,o.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Object%E2%80%93relational_mapping"},"ORM abstraction"),"."),(0,o.kt)("p",null,"To set up the database, you can take the following steps:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Build the code")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"npm run build\n")),(0,o.kt)("ol",{start:2},(0,o.kt)("li",{parentName:"ol"},"Remove the template's default migration:")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"rm -rf db/migrations/*.js\n")),(0,o.kt)("ol",{start:3},(0,o.kt)("li",{parentName:"ol"},"Make sure the Postgres Docker container, ",(0,o.kt)("inlineCode",{parentName:"li"},"squid-evm-template_db_1"),", is running")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"docker ps -a\n")),(0,o.kt)("ol",{start:4},(0,o.kt)("li",{parentName:"ol"},"Drop the current database (if you have never run the project before, this is not necessary), create a new database, create the initial migration, and apply the migration")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"npx sqd db drop\nnpx sqd db create\nnpx sqd db create-migration Init\nnpx sqd db migrate\n")),(0,o.kt)("h2",{id:"launch-the-project"},"Launch the Project"),(0,o.kt)("p",null,"To launch the processor (this will block the current terminal), you can run the following command:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"node -r dotenv/config lib/processor.js\n")),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"3",src:n(5410).Z,width:"944",height:"720"})),(0,o.kt)("p",null,"Finally, in a separate terminal window, launch the GraphQL server:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"npx squid-graphql-server\n")),(0,o.kt)("p",null,"Visit ",(0,o.kt)("a",{parentName:"p",href:"http://localhost:4350/graphql"},(0,o.kt)("inlineCode",{parentName:"a"},"localhost:4350/graphql"))," to access the ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/graphql/graphiql"},"GraphiQl")," console. From this window, you can perform queries such as this one, to find out the account owners with the biggest balances:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-graphql"},"query MyQuery {\n  owners(limit: 10, where: {}, orderBy: balance_DESC) {\n    balance\n    id\n  }\n}\n")),(0,o.kt)("p",null,"Or this other one, looking up the tokens owned by a given owner:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-graphql"},'query MyQuery {\n  tokens(where: {owner: {id_eq: "0x1210F3eA18Ef463c162FFF9084Cee5B6E5ccAb37"}}) {\n    uri\n    contract {\n      id\n      name\n      symbol\n      totalSupply\n    }\n  }\n}\n')),(0,o.kt)("p",null,"Have some fun playing around with queries, after all, it's a ",(0,o.kt)("em",{parentName:"p"},"playground"),"!"),(0,o.kt)("h2",{id:"publish-the-project"},"Publish the Project"),(0,o.kt)("p",null,"Subsquid offers a SaaS solution to host projects created by its community. Please refer to the ",(0,o.kt)("a",{parentName:"p",href:"https://docs.subsquid.io/tutorial/deploy-your-squid"},"Deploy your Squid tutorial")," on Subquid's documentation site for more information."),(0,o.kt)("p",null,"You can also check out other projects hosted there, by heading to the ",(0,o.kt)("a",{parentName:"p",href:"https://app.subsquid.io/aquarium"},"Aquarium"),", because that's where Squids are!"),(0,o.kt)("h2",{id:"example-project-repository"},"Example Project Repository"),(0,o.kt)("p",null,"You can view the ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/subsquid/squid-astar-example"},"finalized and complete project on GitHub"),"."),(0,o.kt)("h2",{id:"whats-next"},"What's next"),(0,o.kt)("p",null,"Subsquid EVM template is the best starting point for EVM contract indexing. The template and this guide show how to index the ",(0,o.kt)("inlineCode",{parentName:"p"},"Transfer")," event for ERC-721 tokens, but the same process can be applied to ERC-20 tokens as well. It is sufficient to import a new ABI interface, make the necessary changes to the ",(0,o.kt)("inlineCode",{parentName:"p"},"schema.graphql"),", launch the ",(0,o.kt)("inlineCode",{parentName:"p"},"codegen")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"evm-typegen")," tools, and finally adjust the helper and handler functions in ",(0,o.kt)("inlineCode",{parentName:"p"},"contract.ts"),"."),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://docs.subsquid.io/"},"Subsquid's documentation")," contains informative material and it's the best place to start, if you are curious about some aspects that were not fully explained in this guide."),(0,o.kt)("p",null,"You can finally join the ",(0,o.kt)("a",{parentName:"p",href:"https://t.me/HydraDevs"},"Telegram SquidDev group")," and the ",(0,o.kt)("a",{parentName:"p",href:"https://discord.gg/dxR4wNgdjV"},"Subsquid Discord server"),", to join the community of builders."))}h.isMDXComponent=!0},6797:function(e,t,n){t.Z=n.p+"assets/images/1-05adeb2c68aa6ce35f587f1dfd4a31a4.gif"},3094:function(e,t,n){t.Z=n.p+"assets/images/2-234ad3bd1d1c7084e8d5eb703759225d.gif"},5410:function(e,t,n){t.Z=n.p+"assets/images/3-b3c66aeae1280fd4e618d5173df437c1.gif"}}]);