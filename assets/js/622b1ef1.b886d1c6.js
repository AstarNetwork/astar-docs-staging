"use strict";(self.webpackChunkdocs_1=self.webpackChunkdocs_1||[]).push([[3450],{3905:function(e,t,a){a.d(t,{Zo:function(){return c},kt:function(){return h}});var n=a(7294);function o(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){o(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,o=function(e,t){if(null==e)return{};var a,n,o={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(o[a]=e[a]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(o[a]=e[a])}return o}var s=n.createContext({}),p=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},c=function(e){var t=p(e.components);return n.createElement(s.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},u=n.forwardRef((function(e,t){var a=e.components,o=e.mdxType,r=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),u=p(a),h=o,m=u["".concat(s,".").concat(h)]||u[h]||d[h]||r;return a?n.createElement(m,i(i({ref:t},c),{},{components:a})):n.createElement(m,i({ref:t},c))}));function h(e,t){var a=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=a.length,i=new Array(r);i[0]=u;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:o,i[1]=l;for(var p=2;p<r;p++)i[p]=a[p];return n.createElement.apply(null,i)}return n.createElement.apply(null,a)}u.displayName="MDXCreateElement"},8355:function(e,t,a){a.r(t),a.d(t,{assets:function(){return c},contentTitle:function(){return s},default:function(){return h},frontMatter:function(){return l},metadata:function(){return p},toc:function(){return d}});var n=a(7462),o=a(3366),r=(a(7294),a(3905)),i=["components"],l={sidebar_position:1},s="Defi Llama",p={unversionedId:"integrations/dapp-listing/defillama",id:"integrations/dapp-listing/defillama",title:"Defi Llama",description:"Defi Llama provides inclusive, non-biased, and community-driven statistics for the decentralized finance industry.",source:"@site/docs/integrations/dapp-listing/defillama.md",sourceDirName:"integrations/dapp-listing",slug:"/integrations/dapp-listing/defillama",permalink:"/docs/integrations/dapp-listing/defillama",editUrl:"https://github.com/AstarNetwork/astar-docs/tree/main/docs/integrations/dapp-listing/defillama.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1},sidebar:"tutorialSidebar",previous:{title:"Gas Price API",permalink:"/docs/integrations/gas_api"},next:{title:"DappRadar",permalink:"/docs/integrations/dapp-listing/dappradar"}},c={},d=[{value:"How to list an Astar/Shiden DeFi project on Defi Llama",id:"how-to-list-an-astarshiden-defi-project-on-defi-llama",level:2},{value:"How to build an adapter",id:"how-to-build-an-adapter",level:2},{value:"Types of adapters",id:"types-of-adapters",level:3},{value:"Which adapter type should I develop?",id:"which-adapter-type-should-i-develop",level:3},{value:"How to write an SDK adapter",id:"how-to-write-an-sdk-adapter",level:2},{value:"Basic adapter",id:"basic-adapter",level:3},{value:"Testing",id:"testing",level:3},{value:"Submit",id:"submit",level:2},{value:"How to write a fetch adapter",id:"how-to-write-a-fetch-adapter",level:2},{value:"How to update a project",id:"how-to-update-a-project",level:2}],u={toc:d};function h(e){var t=e.components,a=(0,o.Z)(e,i);return(0,r.kt)("wrapper",(0,n.Z)({},u,a,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"defi-llama"},"Defi Llama"),(0,r.kt)("p",null,"Defi Llama provides inclusive, non-biased, and community-driven statistics for the decentralized finance industry."),(0,r.kt)("p",null,"Astar/ Shiden is live on Defi Llama. Defi Llama maintains homepages for the top DeFi apps under ",(0,r.kt)("a",{parentName:"p",href:"https://defillama.com/chain/Astar"},"Astar Defi")," and ",(0,r.kt)("a",{parentName:"p",href:"https://defillama.com/chain/Shiden"},"Shiden Defi"),"."),(0,r.kt)("h2",{id:"how-to-list-an-astarshiden-defi-project-on-defi-llama"},"How to list an Astar/Shiden DeFi project on Defi Llama"),(0,r.kt)("p",null,"To list on Defi Llama:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Fork the ",(0,r.kt)("a",{parentName:"li",href:"https://github.com/DefiLlama/DefiLlama-Adapters"},"Adapters repo"),' ("Fork" button towards the top right of the repo page).'),(0,r.kt)("li",{parentName:"ol"},"Add a new folder with the same name as the project to ",(0,r.kt)("inlineCode",{parentName:"li"},"projects/"),"."),(0,r.kt)("li",{parentName:"ol"},"Write an ",(0,r.kt)("a",{parentName:"li",href:"https://app.gitbook.com/o/-LgGrgOEDyFYjYWIb1DT/s/-M8GVK5H7hOsGnYqg-7q-872737601/integration/dapp-listing/defillama#how-to-write-an-sdk-adapter"},"SDK adapter")," (or a ",(0,r.kt)("a",{parentName:"li",href:"https://app.gitbook.com/o/-LgGrgOEDyFYjYWIb1DT/s/-M8GVK5H7hOsGnYqg-7q-872737601/integration/dapp-listing/defillama#how-to-write-a-fetch-adapter"},"fetch adapter")," if you cant use the SDK for this project) in the new folder."),(0,r.kt)("li",{parentName:"ol"},"Make a Pull Request with the changes on your fork, to the main Defi Llama Adapters repo, with a brief explanation of what you changed."),(0,r.kt)("li",{parentName:"ol"},"Wait for someone to either comment on or merge your Pull Request. There is no need to ask for someone to check your PR as there a monitored regularly."),(0,r.kt)("li",{parentName:"ol"},"Once your PR has been merged, please give 24 hours for the front-end team to load your listing onto the UI.")),(0,r.kt)("h2",{id:"how-to-build-an-adapter"},"How to build an adapter"),(0,r.kt)("p",null,"An adapter is just some code that:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Collects data on a protocol by calling some endpoints or making some blockchain calls"),(0,r.kt)("li",{parentName:"ol"},"Computes the TVL of a protocol and returns it")),(0,r.kt)("h3",{id:"types-of-adapters"},"Types of adapters"),(0,r.kt)("p",null,"Right now there are two types of adapters co-existing within the repository:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://app.gitbook.com/o/-LgGrgOEDyFYjYWIb1DT/s/-M8GVK5H7hOsGnYqg-7q-872737601/integration/dapp-listing/defillama#how-to-write-a-fetch-adapter"},"Fetch adapters"),": These calculate the TVL directly and just export a fetch method"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://app.gitbook.com/o/-LgGrgOEDyFYjYWIb1DT/s/-M8GVK5H7hOsGnYqg-7q-872737601/integration/dapp-listing/defillama#how-to-write-an-sdk-adapter"},"SDK adapters"),": These use the SDK and return all the assets locked along with their balances")),(0,r.kt)("h3",{id:"which-adapter-type-should-i-develop"},"Which adapter type should I develop?"),(0,r.kt)("p",null,"Right now Defi Llama SDK only supports EVM chains, so if your project is in any of these chains you should develop an SDK-based adapter, while if your project is on another chain a fetch adapter is likely the way to go. If your project is not on an EVM chain but you are able to give us historical data, we can help support this if you message us in Discord."),(0,r.kt)("h2",{id:"how-to-write-an-sdk-adapter"},"How to write an SDK adapter"),(0,r.kt)("h3",{id:"basic-adapter"},"Basic adapter"),(0,r.kt)("p",null,"Below, you can see the one AstridDAO used on Astar Network (ASTR). Let's walk through it to get a better understanding of how it works."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'const { sumTokens } = require(\'../helper/unwrapLPs\')\nconst { getFixBalances } = require(\'../helper/portedTokens\')\n\nconst WASTAR = "0x19574c3c8fafc875051b665ec131b7e60773d2c9"\nconst chain = \'astar\'\n\nconst CONTRACT_ADDRESSES = {\n  // Pools holding ASTR.\n  ACTIVE_POOL: "0x70724b57618548eE97623146F76206033E67086e",\n  DEFAULT_POOL: "0x2fE3FDf91786f75C92e8AB3B861588D3D051D83F",\n};\n\nasync function tvl(ts, _block, chainBlocks ) {\n  const block = chainBlocks[chain]\n  const balances = {}\n  const tokensAndOwners = Object.values(CONTRACT_ADDRESSES).map(owner => [WASTAR, owner])\n  await sumTokens(balances, tokensAndOwners, block, chain);\n  (await getFixBalances(chain))(balances)\n  return balances\n}\n\nmodule.exports = {\n  timetravel: true,\n  start: 915830,\n  methodology: "Total locked ASTR (in wrapped ERC-20 form) in ActivePool and DefaultPool",\n  astar: {\n    tvl,\n  },\n};\n')),(0,r.kt)("p",null,"The adapter consists of 3 main sections. First, any dependencies we want to use. Next, an async function containing the code for calculating TVL (where the bulk of the code usually is). Finally, the module exports."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Line 13 - Input Parameters")),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"The first param taken by the function (line 13) will be a timestamp. In your testing, this will be the current timestamp, but when we backfill chart data for your protocol, past timestamps will also be input."),(0,r.kt)("li",{parentName:"ol"},"Next is the mainnet block height corresponding to the timestamp in the first param.")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Line 15 - Initialising The Balances Object")),(0,r.kt)("p",null,"SDK adapters always export balance objects, which is a dictionary where all the keys are either token addresses or Coingecko token IDs. On this line, we just initialize the balance object to be empty."),(0,r.kt)("p",null,"If a token balance has an address key, the Defi Llama SDK will manage any raw to real amount conversion for you (so you don't need to worry about ERC20 decimals). If a token balance has a Coingecko ID key, you will need to process the decimals and use a real token amount in the balances object."),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"If you export token addresses in your balances object that isn't on CoinGecko, Defi Llama won't be able to fetch prices for the tokens. You can check which addresses are supported by going to the token on CoinGecko and checking the  'Contract' field on the right (pictured above).")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Line 17 - Adding Data To The Balances Object")),(0,r.kt)("p",null,"In the SDK we have utilities to add data to the balances dictionary. sdk.util.sumSingleBalance() takes 3 parameters:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"The object you want to add token balances to."),(0,r.kt)("li",{parentName:"ol"},"The token key you want to add to. We will transform the token address."),(0,r.kt)("li",{parentName:"ol"},"The balance we want to add. (NB: If we were using ae CoinGecko ID in position 2, we'd need to divide collateralBalance by 10 ** ",(0,r.kt)("inlineCode",{parentName:"li"},"token_decimal_places")," to convert the raw balance to a real balance).")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Line 22 - Module Exports")),(0,r.kt)("p",null,"The module exports must be constructed correctly, and use the correct keys, so that the Defi Llama UI can show your data. Nest chain TVL (and separate types of TVL like staking, pool2 etc) inside the chain key (eg '",(0,r.kt)("inlineCode",{parentName:"p"},"astar"),"', '",(0,r.kt)("inlineCode",{parentName:"p"},"shiden"),"')."),(0,r.kt)("p",null,"Please also let us know:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"timetravel (bool) - if we can backfill data with your adapter. Most SDK adapters will allow this, but not all. For example, if you fetch a list of live contracts from an API before querying data on-chain, timetravel should be 'false'."),(0,r.kt)("li",{parentName:"ul"},"misrepresentedTokens (bool) - if you have used token substitutions at any point in the adapter this should be 'true'."),(0,r.kt)("li",{parentName:"ul"},"methodology (string) - this is a small description that will explain to Defi Llama users how the adapter works out your protocol's TVL."),(0,r.kt)("li",{parentName:"ul"},"start (number) - the earliest block height the adapter will work at.")),(0,r.kt)("h3",{id:"testing"},"Testing"),(0,r.kt)("p",null,"Once you are done writing it you can verify that it returns the correct value by running the following code:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"npm install\n# Replace with your adapter's name\nnode test.js projects/astriddao/index.js \n")),(0,r.kt)("p",null,"If the adapter runs successfully, the console will show you a breakdown of your project's TVL in USD. If it all looks accurate, you're ready to submit."),(0,r.kt)("h2",{id:"submit"},"Submit"),(0,r.kt)("p",null,"Just submit a PR to the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/DefiLlama/DefiLlama-Adapters"},"adapter repository on Github"),"!"),(0,r.kt)("hr",null),(0,r.kt)("h2",{id:"how-to-write-a-fetch-adapter"},"How to write a fetch adapter"),(0,r.kt)("p",null,"Fetch adapters export a function, called ",(0,r.kt)("inlineCode",{parentName:"p"},"fetch"),", which returns a project's total TVL (in USD) as a number. The following basic adapter would just always return a TVL of $100:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"async function fetch() {\n  return 100;\n}\n\nmodule.exports = {\n  fetch\n}\n")),(0,r.kt)("p",null,"Fetch adapters only allow us to get the TVL at the current time, so it's impossible to fill old values on a protocol's TVL chart or recompute them, thus leading to charts that look jumpy. To solve this we introduced SDK adapters, which allow us to retrieve a protocol's TVL at any point in time."),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Fetch adapters can only be used for projects on non-EVM chains. Where possible, ",(0,r.kt)("a",{parentName:"p",href:"https://app.gitbook.com/o/-LgGrgOEDyFYjYWIb1DT/s/-M8GVK5H7hOsGnYqg-7q-872737601/integration/dapp-listing/defillama"},"SDK adapters")," are preferred to fetch adapters because on-chain calls are more transparent.")),(0,r.kt)("p",null,"Third-party APIs should be used where possible to reduce bias. If third-party APIs are not available for the data you need, proprietary APIs can be used if they're open source."),(0,r.kt)("hr",null),(0,r.kt)("p",null,"Examples"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const retry = require('async-retry')\nconst { GraphQLClient, gql } = require('graphql-request')\n\nasync function fetch() {\n  var endpoint ='https://api.thegraph.com/subgraphs/name/balancer-labs/balancer';\n  var graphQLClient = new GraphQLClient(endpoint)\n\n  var query = gql`\n  {\n    balancers(first: 5) {\n      totalLiquidity,\n      totalSwapVolume\n    }\n  }\n  `;\n  const results = await retry(async bail => await graphQLClient.request(query))\n  return parseFloat(results.balancers[0].totalLiquidity);\n}\n\nmodule.exports = {\n  fetch\n}\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const retry = require('async-retry')\nconst axios = require(\"axios\");\nconst BigNumber = require(\"bignumber.js\");\n\nasync function fetch() {\n  let price_feed = await retry(async bail => await axios.get('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd&include_market_cap=true&include_24hr_vol=true&include_24hr_change=true'))\n  let response = await retry(async bail => await axios.get('https://api.etherscan.io/api?module=stats&action=tokensupply&contractaddress=0xeb4c2781e4eba804ce9a9803c67d0893436bb27d&apikey=H6NGIGG7N74TUH8K2X31J1KB65HFBH2E82'))\n  let tvl = new BigNumber(response.data.result).div(10 ** 8).toFixed(2);\n  return (tvl * price_feed.data.bitcoin.usd);\n}\n\nmodule.exports = {\n  fetch\n}\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const retry = require('async-retry')\nconst axios = require(\"axios\");\nconst BigNumber = require(\"bignumber.js\");\n\nasync function fetch() {\n  var price_feed = await retry(async bail => await axios.get('https://api.coingecko.com/api/v3/simple/price?ids=thorchain&vs_currencies=usd&include_market_cap=true&include_24hr_vol=true&include_24hr_change=true'))\n\n  var res = await retry(async bail => await axios.get('https://chaosnet-midgard.bepswap.com/v1/network'))\n  var tvl = await new BigNumber((parseFloat(res.data.totalStaked) * 2) + parseFloat(res.data.bondMetrics.totalActiveBond) + parseFloat(res.data.bondMetrics.totalStandbyBond)).div(10 ** 8).toFixed(2);\n  tvl = tvl * price_feed.data.thorchain.usd;\n  return tvl;\n}\n\nmodule.exports = {\n  fetch\n}\n")),(0,r.kt)("h2",{id:"how-to-update-a-project"},"How to update a project"),(0,r.kt)("p",null,"If you'd like to update the code used to calculate the TVL of a DeFi project already listed on DefiLlama:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Fork the ",(0,r.kt)("a",{parentName:"li",href:"https://github.com/DefiLlama/DefiLlama-Adapters"},"Adapters repo")," (button towards the top right of the repo page)."),(0,r.kt)("li",{parentName:"ol"},"Make your changes to the fork (generally easiest by cloning your new fork into a desktop IDE)."),(0,r.kt)("li",{parentName:"ol"},"Make a Pull Request from your fork, to the main Defi Llama Adapters repo, with a brief explanation of what you changed."),(0,r.kt)("li",{parentName:"ol"},"Wait for someone to either comment on or merge your Pull Request. There is no need to ask for someone to check your PR as there a monitored regularly.")),(0,r.kt)("p",null,"If you'd like to update the metadata (name, logo, description etc) of a project already listed on DefiLlama:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Join the ",(0,r.kt)("a",{parentName:"li",href:"https://discord.gg/bQNGsqgD"},"DefiLlama Discord server"),"."),(0,r.kt)("li",{parentName:"ol"},"Message the ",(0,r.kt)("inlineCode",{parentName:"li"},"#listings")," channel about the changes you'd like to make."),(0,r.kt)("li",{parentName:"ol"},"Wait for a response from the team")),(0,r.kt)("p",null,"If you don't have a Discord account, you can always reach the Defi Llama team through Github or Twitter. Responses are generally quicker on Discord."),(0,r.kt)("p",null,"If you'd like to list or update the listing for an NFT project, also get in contact with the Defi Llama team over Discord."))}h.isMDXComponent=!0}}]);